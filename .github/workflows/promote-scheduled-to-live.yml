name: Promote scheduled-updates into live

on:
  workflow_dispatch:
  schedule:
    # every 5 minutes (minimum GitHub allows). cron is UTC.
    - cron: "*/5 * * * *"

permissions:
  contents: write

concurrency:
  group: scheduled-updates-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout LIVE repo (this repo) into workspace root
      - name: Checkout live repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Checkout SOURCE repo (scheduled-updates) into a subfolder
      - name: Checkout scheduled-updates repo
        uses: actions/checkout@v4
        with:
          repository: YOUR_OWNER_OR_ORG/scheduled-updates
          ref: main
          path: __source
          # If scheduled-updates is private OR in a different org, create a PAT secret named SOURCE_REPO_TOKEN
          token: ${{ secrets.SOURCE_REPO_TOKEN || github.token }}

      # 3) Replace live repo contents with source contents (excluding git + this workflow file)
      - name: Sync files into live repo
        shell: bash
        run: |
          set -euo pipefail

          rsync -a --delete \
            --exclude ".git/" \
            --exclude "__source/" \
            --exclude ".github/workflows/scheduled-sync.yml" \
            "__source/" "./"

      # 4) Commit & push only if changes exist
      - name: Commit and push changes (if any)
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          # Re-check after staging (in case only deletions/rsync noise)
          if git diff --cached --quiet; then
            echo "No staged changes."
            exit 0
          fi

          git commit -m "Sync from scheduled-updates ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
          git push
